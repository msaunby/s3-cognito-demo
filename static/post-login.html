<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>status</title>
    <script src="amazon-cognito-identity.min.js"></script>
    <script src="aws-sdk.min.js"></script>
    <script src="jwt-decode.js"></script>
</head>
<body>
    <p>
        This data will confirm if a user is logged in.
    </p>
    <code id="userdata">Hello</code>
    <p>
        These are the key/value pairs for localStorage.
    </p>
    <code id="storage">Storage</code>
    <div id="s3ListOut"></div> 
    <script>
    AWS_COGNITO_USER_POOL_ID = 'eu-west-2_7EYlL3eMQ';
    AWS_COGNITO_USER_POOL_CLIENT_ID = 'ffjmv51r3e7s0ht3b4eo7s93c';
    
    AWS_DEFAULT_REGION = 'eu-west-2';
    AWS_COGNITO_IDENTITY_POOL_ID = 'eu-west-2:cd6890c8-4e8a-4f5f-bdaa-f84a77adc4c9';
    S3_BUCKET_NAME = 'protected.saunby.net';
    AWS_COGNITO_USER_POOL_PROVIDER = 'cognito-idp.eu-west-2.amazonaws.com/eu-west-2_7EYlL3eMQ';

    var poolData = {
        UserPoolId : AWS_COGNITO_USER_POOL_ID,
        ClientId : AWS_COGNITO_USER_POOL_CLIENT_ID
    };

    var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);


    console.log(window.location);
    const url = new URL(window.location);
    console.log(url.hash);


    const searchParams = new URLSearchParams(url.hash.substring(1));
    var idToken = undefined;

    // Iterating the search parameters
    for (const p of searchParams) {
        console.log(p[0]);
        if( p[0] == "id_token"){
            idToken = p[1];
        } 
    }

    console.log("ID", idToken);

    AWS.config.region = AWS_DEFAULT_REGION;
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                            IdentityPoolId: AWS_COGNITO_IDENTITY_POOL_ID,
                            Logins: {
                                [AWS_COGNITO_USER_POOL_PROVIDER] : idToken
                            }
    });

    AWS.config.credentials.get(function(err) {
                            if (err){
                                console.error("get credentials failed");
                                console.error(err);
                                return;
                            }                                                                                                                                                                                                          
                            var s3 = new AWS.S3({
                                apiVersion: '2006-03-01',
                                params: {Bucket: S3_BUCKET_NAME}
                            });

                            var prefix = '';
                            s3.listObjects({Prefix: prefix}, function(err, data) {
                                if (err){
                                    console.error("list objects failed");
                                    console.error(err, data);
                                    return;
                                }
                                const listOut = document.querySelector('#s3ListOut');
                                var list = "";
                                data.Contents.forEach(element => {
                                    params = {Bucket: S3_BUCKET_NAME, Key: element.Key};
                                    var url = s3.getSignedUrl('getObject', params);
                                    list += '<a href="'+url+'">' + element.Key + '</a><br>';   
                                });
                                listOut.innerHTML =  list;
                            });
                        });
    




    user_el = document.getElementById('userdata');
    user_el.innerHTML = '{}';
    storage_el = document.getElementById('storage');
    storage_el.innerHTML = "";
    var poolData = {
            UserPoolId : AWS_COGNITO_USER_POOL_ID,
            ClientId : AWS_COGNITO_USER_POOL_CLIENT_ID
        };
        var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        
        cognitoUser = userPool.getCurrentUser();
        
        if (cognitoUser) {
        
            cognitoUser.getSession(function(err, result) {
                if (result) {
                    // Now logged in.
                    // We can find out more about the user by calling getUserData().
                    // Note this is optional, we could just go straight to
                    // getting an id token and accessing protected data.  
                    cognitoUser.getUserData(function(err, userData) {
                        if (err) {
                            alert(err.message || JSON.stringify(err));
                            return;
                        }
                        user_el.innerHTML = JSON.stringify(userData);

                    }); 
         
                    // Get access or id token if required, e.g. for S3 bucket access
                    // var accessToken = result.getAccessToken().getJwtToken();
                    // var idToken = result.idToken.jwtToken;
                }
            }
        );
    }

    var token = "eyJraWQiOiJCWkFHdlBVY2R0RzFhWnRnSkNXcXExaHF3M0xrTkI4S3dsNWtQcVBQcXRRPSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiJhZDhkNTZiNC1jYjljLTRiMTQtYmVhZi1jMDU0NzVlNWYxZWQiLCJpc3MiOiJodHRwczpcL1wvY29nbml0by1pZHAuZXUtd2VzdC0yLmFtYXpvbmF3cy5jb21cL2V1LXdlc3QtMl9MeFRXeXJneFkiLCJ2ZXJzaW9uIjoyLCJjbGllbnRfaWQiOiJoY2dsM3NpajlnOHZtZ2I0bnFyaGJhc2xrIiwiZXZlbnRfaWQiOiJkYWI2YzE2MS1hNmIxLTQ0NDctOTM1YS00YzkyYjg0YWFmMjEiLCJ0b2tlbl91c2UiOiJhY2Nlc3MiLCJzY29wZSI6ImF3cy5jb2duaXRvLnNpZ25pbi51c2VyLmFkbWluIiwiYXV0aF90aW1lIjoxNjc4NTY1NDQ2LCJleHAiOjE2Nzg1NjY2NDYsImlhdCI6MTY3ODU2NTQ0NiwianRpIjoiZmM4YzY4ZjctZGNiNi00NmVhLWE2MzQtYWZhMGFiNzk2MjVhIiwidXNlcm5hbWUiOiJhZDhkNTZiNC1jYjljLTRiMTQtYmVhZi1jMDU0NzVlNWYxZWQifQ.MKFs9EM7xTjkiTMVehV515WTutZ2SRg3lc4rg7UkWgv9lGYwSf-pnrzDw0hBVJScr2o71i6XHyCAB2MC75RMzxX4WuQptr0bQ5c4kALrEDDyHAKPMNUuxfz8S1f-AcTJLnbpd5fGBR0Bwk1wyd_t7oX6vyzShgqLgeh-5ywqW7MBNzFO-CI8LAr7VVXg9g7nyV9mgx91e-0Cwxkr1ROi_jpz0OdthdbMvE4QrprK4yy7olwPZBRLQjevmtegU_OfXfWfBFF67EkP0yfri9vYr69y2EkPb0M6gEuRaVKZRucNCpYFtmGNUlAc0wV1py-D5iWf45joDc7r2W2jxMt0Xg";
    var decoded = jwt_decode(token);
    console.log(decoded);
    console.log(Object.keys(localStorage));

    var keys = "";
    Object.keys(localStorage).forEach(element => {
        keys += "<br>" + element + ": ";
        try{
            keys += "<br>[JWT] " + JSON.stringify(jwt_decode(localStorage.getItem(element))) + "<br>";
        }catch{
            keys += "<br>[TEXT] " +  localStorage.getItem(element) + "<br>";
        }
    });
    storage_el.innerHTML = keys;

    </script>
</body>
</html>
