<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>listS3</title>
    <script src="amazon-cognito-identity.min.js"></script>
    <script src="aws-sdk.min.js"></script>
</head>
<body>
    <div id="s3ListOut"></div> 
    <script>
        AWS_COGNITO_USER_POOL_ID = 'eu-west-2_7EYlL3eMQ';
        AWS_COGNITO_USER_POOL_CLIENT_ID = 'ffjmv51r3e7s0ht3b4eo7s93c';

        AWS_DEFAULT_REGION = 'eu-west-2';
        AWS_COGNITO_IDENTITY_POOL_ID = 'eu-west-2:cd6890c8-4e8a-4f5f-bdaa-f84a77adc4c9';
        S3_BUCKET_NAME = 'protected.saunby.net';
        AWS_COGNITO_USER_POOL_PROVIDER = 'cognito-idp.eu-west-2.amazonaws.com/eu-west-2_7EYlL3eMQ';
    
        var poolData = {
            UserPoolId : AWS_COGNITO_USER_POOL_ID,
            ClientId : AWS_COGNITO_USER_POOL_CLIENT_ID
        };

        var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
            
        cognitoUser = userPool.getCurrentUser();
            
        if (cognitoUser) {
            
            cognitoUser.getSession(function(err, result) {
                if (result) {
                        // Now logged in.
                        // Get id token for S3 bucket access
                        var idToken = result.idToken.jwtToken;
                        var accessToken = result.getAccessToken().getJwtToken();

                        AWS.config.region = AWS_DEFAULT_REGION;
                        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                            IdentityPoolId: AWS_COGNITO_IDENTITY_POOL_ID,
                            Logins: {
                                [AWS_COGNITO_USER_POOL_PROVIDER] : idToken
                            }
                        });

                        AWS.config.credentials.get(function(err) {
                            if (err){
                                console.error("get credentials failed");
                                console.error(err);
                                return;
                            }                                                                                                                                                                                                          
                            var s3 = new AWS.S3({
                                apiVersion: '2006-03-01',
                                params: {Bucket: S3_BUCKET_NAME}
                            });

                            var prefix = '';
                            s3.listObjects({Prefix: prefix}, function(err, data) {
                                if (err){
                                    console.error("list objects failed");
                                    console.error(err, data);
                                    return;
                                }
                                const listOut = document.querySelector('#s3ListOut');
                                var list = "";

                                // Note that default expiry is 15 minutes.
                                // See https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getSignedUrl-property
                                data.Contents.forEach(element => {
                                    params = {Bucket: S3_BUCKET_NAME, Key: element.Key};
                                    var url = s3.getSignedUrl('getObject', params);
                                    list += '<a href="'+url+'">' + element.Key + '</a><br>';   
                                });
                                listOut.innerHTML =  list;
                            });
                        });
                }
            });
        } else {
                    const listOut = document.querySelector('#s3ListOut');
                    listOut.innerHTML =  '<p>Not authorised.<br>Please <a href="/">sign in</a>.</p>'; 
        }
</script>

</body>
</html>